 <!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>File Upload with Progress</title>
    <style>
      /* 简单美化 */
      #progressContainer { margin-top: 1em; display: none; }
      #progressText { margin-left: 0.5em; }
    </style>
</head>
<body>
    <h2>Upload a File</h2>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul style="color: red;">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- 表单只留 file input 和提交按钮，action/method/enctype 由 JS 控制 -->
    <form id="uploadForm">
        <input type="file" name="file" id="fileInput" required />
        <button type="submit">Upload</button>
    </form>

    <!-- 进度条区域 -->
    <div id="progressContainer">
      <progress id="progressBar" value="0" max="100" style="width:300px;"></progress>
      <span id="progressText">0%</span>
    </div>

    <hr>
    <h3>Uploaded Files</h3>
    <ul>
      {% for file in files %}
        <li>
          {{ file }} -
          <a href="{{ url_for('download_file', filename=file) }}">⬇ Download</a>
        </li>
      {% endfor %}
    </ul>

    <script>
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const fileInput = document.getElementById('fileInput');
      if (!fileInput.files.length) return;

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/', true);

      // 上传开始前显示进度条
      const progContainer = document.getElementById('progressContainer');
      const progBar = document.getElementById('progressBar');
      const progText = document.getElementById('progressText');
      progContainer.style.display = 'block';
      progBar.value = 0;
      progText.textContent = '0%';

      // 监听进度
      xhr.upload.onprogress = function(evt) {
        if (evt.lengthComputable) {
          const percent = Math.round(evt.loaded / evt.total * 100);
          progBar.value = percent;
          progText.textContent = percent + '%';
        }
      };

      // 上传完成
      xhr.onload = function() {
        if (xhr.status === 200) {
          // 上传成功，刷新页面显示新列表和 flash
          window.location.reload();
        } else {
          alert('Upload failed: ' + xhr.responseText);
          progContainer.style.display = 'none';
        }
      };

      xhr.onerror = function() {
        alert('Upload error.');
        progContainer.style.display = 'none';
      };

      xhr.send(formData);
    });
    </script>
</body>
</html>
